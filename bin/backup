#!/usr/bin/env bash
set -eo pipefail

# configure rclone
# rclone config
# check existing config
# rclone config show ds9sftp

echo "restic auth"
export RESTIC_PASSWORD=$(passage restic)

echo "rclone auth"
export RCLONE_CONFIG_PASS=$(passage rclone)

# yubikey-agent receives HUP because of age-plugin-yubikey when using passage
# as a workaround force yubikey-agent to reclaim the session
# whent the lights go out on the yubikey after 5 seconds the session otherwise drops
ssh-add -l > /dev/null 2>&1 || true

echo "proceeding..."
echo ""

REPO="rclone:ds9sftp:/home/backup/robbie_restic"

restic -r "$REPO" backup \
  ~/dropbox \
  ~/Games/pd2/drive_c/d2/Save

restic -r "$REPO" forget --keep-monthly 5 --keep-last 5 --prune

#restic -r "$REPO" check --read-data
